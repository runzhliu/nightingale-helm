{{- if .Values.initMysql.enabled }}
apiVersion: v1
data:
  a-n9e.sql: |
    set names utf8mb4;

    drop database if exists n9e_v5;
    create database n9e_v5;
    use n9e_v5;

    CREATE TABLE `user` (
                            `id` bigint unsigned not null auto_increment,
                            `username` varchar(64) not null comment 'login name, cannot rename',
                            `nickname` varchar(64) not null comment 'display name, chinese name',
                            `password` varchar(128) not null default '',
                            `phone` varchar(16) not null default '',
                            `email` varchar(64) not null default '',
                            `portrait` varchar(255) not null default '' comment 'portrait image url',
                            `roles` varchar(255) not null comment 'Admin | Standard | Guest, split by space',
                            `contacts` varchar(1024) comment 'json e.g. {wecom:xx, dingtalk_robot_token:yy}',
                            `create_at` bigint not null default 0,
                            `create_by` varchar(64) not null default '',
                            `update_at` bigint not null default 0,
                            `update_by` varchar(64) not null default '',
                            PRIMARY KEY (`id`),
                            UNIQUE KEY (`username`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    insert into `user`(id, username, nickname, password, roles, create_at, create_by, update_at, update_by, contacts) values(1, 'root', '超管', 'root.2020', 'Admin', unix_timestamp(now()), 'system', unix_timestamp(now()), 'system', '{"wecom_robot_token":"3046ecc7-44b8-4e42-adfa-52f69781255d"}');

    CREATE TABLE `user_group` (
                                  `id` bigint unsigned not null auto_increment,
                                  `name` varchar(128) not null default '',
                                  `note` varchar(255) not null default '',
                                  `create_at` bigint not null default 0,
                                  `create_by` varchar(64) not null default '',
                                  `update_at` bigint not null default 0,
                                  `update_by` varchar(64) not null default '',
                                  PRIMARY KEY (`id`),
                                  KEY (`create_by`),
                                  KEY (`update_at`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    insert into user_group(id, name, create_at, create_by, update_at, update_by) values(1, 'demo-root-group', unix_timestamp(now()), 'root', unix_timestamp(now()), 'root');

    CREATE TABLE `user_group_member` (
                                         `group_id` bigint unsigned not null,
                                         `user_id` bigint unsigned not null,
                                         KEY (`group_id`),
                                         KEY (`user_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    insert into user_group_member(group_id, user_id) values(1, 1);

    CREATE TABLE `configs` (
                               `id` bigint unsigned not null auto_increment,
                               `ckey` varchar(191) not null,
                               `cval` varchar(1024) not null default '',
                               PRIMARY KEY (`id`),
                               UNIQUE KEY (`ckey`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `role` (
                            `id` bigint unsigned not null auto_increment,
                            `name` varchar(191) not null default '',
                            `note` varchar(255) not null default '',
                            PRIMARY KEY (`id`),
                            UNIQUE KEY (`name`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    insert into `role`(name, note) values('Admin', 'Administrator role');
    insert into `role`(name, note) values('Standard', 'Ordinary user role');
    insert into `role`(name, note) values('Guest', 'Readonly user role');

    CREATE TABLE `role_operation`(
                                     `role_name` varchar(128) not null,
                                     `operation` varchar(191) not null,
                                     KEY (`role_name`),
                                     KEY (`operation`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    -- Admin is special, who has no concrete operation but can do anything.
    insert into `role_operation`(role_name, operation) values('Guest', '/metric/explorer');
    insert into `role_operation`(role_name, operation) values('Guest', '/object/explorer');
    insert into `role_operation`(role_name, operation) values('Guest', '/help/version');
    insert into `role_operation`(role_name, operation) values('Guest', '/help/contact');
    insert into `role_operation`(role_name, operation) values('Standard', '/metric/explorer');
    insert into `role_operation`(role_name, operation) values('Standard', '/object/explorer');
    insert into `role_operation`(role_name, operation) values('Standard', '/help/version');
    insert into `role_operation`(role_name, operation) values('Standard', '/help/contact');
    insert into `role_operation`(role_name, operation) values('Standard', '/users');
    insert into `role_operation`(role_name, operation) values('Standard', '/user-groups');
    insert into `role_operation`(role_name, operation) values('Standard', '/user-groups/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/user-groups/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/user-groups/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/busi-groups');
    insert into `role_operation`(role_name, operation) values('Standard', '/busi-groups/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/busi-groups/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/busi-groups/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/targets');
    insert into `role_operation`(role_name, operation) values('Standard', '/targets/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/targets/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/targets/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/dashboards');
    insert into `role_operation`(role_name, operation) values('Standard', '/dashboards/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/dashboards/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/dashboards/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-rules');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-rules/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-rules/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-rules/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-mutes');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-mutes/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-mutes/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-subscribes');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-subscribes/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-subscribes/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-subscribes/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-cur-events');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-cur-events/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/alert-his-events');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tpls');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tpls/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tpls/put');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tpls/del');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tasks');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tasks/add');
    insert into `role_operation`(role_name, operation) values('Standard', '/job-tasks/put');


    -- for alert_rule | collect_rule | mute | dashboard grouping
    CREATE TABLE `busi_group` (
                                  `id` bigint unsigned not null auto_increment,
                                  `name` varchar(191) not null,
                                  `create_at` bigint not null default 0,
                                  `create_by` varchar(64) not null default '',
                                  `update_at` bigint not null default 0,
                                  `update_by` varchar(64) not null default '',
                                  PRIMARY KEY (`id`),
                                  UNIQUE KEY (`name`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    insert into busi_group(id, name, create_at, create_by, update_at, update_by) values(1, 'Default Busi Group', unix_timestamp(now()), 'root', unix_timestamp(now()), 'root');

    CREATE TABLE `busi_group_member` (
                                         `id` bigint unsigned not null auto_increment,
                                         `busi_group_id` bigint not null comment 'busi group id',
                                         `user_group_id` bigint not null comment 'user group id',
                                         `perm_flag` char(2) not null comment 'ro | rw',
                                         PRIMARY KEY (`id`),
                                         KEY (`busi_group_id`),
                                         KEY (`user_group_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    insert into busi_group_member(busi_group_id, user_group_id, perm_flag) values(1, 1, "rw");

    CREATE TABLE `dashboard` (
                                 `id` bigint unsigned not null auto_increment,
                                 `group_id` bigint not null default 0 comment 'busi group id',
                                 `name` varchar(191) not null,
                                 `tags` varchar(255) not null comment 'split by space',
                                 `configs` varchar(8192) comment 'dashboard variables',
                                 `create_at` bigint not null default 0,
                                 `create_by` varchar(64) not null default '',
                                 `update_at` bigint not null default 0,
                                 `update_by` varchar(64) not null default '',
                                 PRIMARY KEY (`id`),
                                 UNIQUE KEY (`group_id`, `name`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    -- auto create the first subclass 'Default chart group' of dashboard
    CREATE TABLE `chart_group` (
                                   `id` bigint unsigned not null auto_increment,
                                   `dashboard_id` bigint unsigned not null,
                                   `name` varchar(255) not null,
                                   `weight` int not null default 0,
                                   PRIMARY KEY (`id`),
                                   KEY (`dashboard_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `chart` (
                             `id` bigint unsigned not null auto_increment,
                             `group_id` bigint unsigned not null comment 'chart group id',
                             `configs` varchar(8192),
                             `weight` int not null default 0,
                             PRIMARY KEY (`id`),
                             KEY (`group_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `chart_share` (
                                   `id` bigint unsigned not null auto_increment,
                                   `cluster` varchar(128) not null,
                                   `configs` text,
                                   `create_at` bigint not null default 0,
                                   `create_by` varchar(64) not null default '',
                                   primary key (`id`),
                                   key (`create_at`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `alert_rule` (
                                  `id` bigint unsigned not null auto_increment,
                                  `group_id` bigint not null default 0 comment 'busi group id',
                                  `cluster` varchar(128) not null,
                                  `name` varchar(255) not null,
                                  `note` varchar(255) not null,
                                  `severity` tinyint(1) not null comment '0:Emergency 1:Warning 2:Notice',
                                  `disabled` tinyint(1) not null comment '0:enabled 1:disabled',
                                  `prom_for_duration` int not null comment 'prometheus for, unit:s',
                                  `prom_ql` varchar(8192) not null comment 'promql',
                                  `prom_eval_interval` int not null comment 'evaluate interval',
                                  `enable_stime` char(5) not null default '00:00',
                                  `enable_etime` char(5) not null default '23:59',
                                  `enable_days_of_week` varchar(32) not null default '' comment 'split by space: 0 1 2 3 4 5 6',
                                  `enable_in_bg` tinyint(1) not null default 0 comment '1: only this bg 0: global',
                                  `notify_recovered` tinyint(1) not null comment 'whether notify when recovery',
                                  `notify_channels` varchar(255) not null default '' comment 'split by space: sms voice email dingtalk wecom',
                                  `notify_groups` varchar(255) not null default '' comment 'split by space: 233 43',
                                  `notify_repeat_step` int not null default 0 comment 'unit: min',
                                  `recover_duration` int not null default 0 comment 'unit: s',
                                  `callbacks` varchar(255) not null default '' comment 'split by space: http://a.com/api/x http://a.com/api/y',
                                  `runbook_url` varchar(255),
                                  `append_tags` varchar(255) not null default '' comment 'split by space: service=n9e mod=api',
                                  `create_at` bigint not null default 0,
                                  `create_by` varchar(64) not null default '',
                                  `update_at` bigint not null default 0,
                                  `update_by` varchar(64) not null default '',
                                  PRIMARY KEY (`id`),
                                  KEY (`group_id`),
                                  KEY (`update_at`)
    ) ENGINE=InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `alert_mute` (
                                  `id` bigint unsigned not null auto_increment,
                                  `group_id` bigint not null default 0 comment 'busi group id',
                                  `cluster` varchar(128) not null,
                                  `tags` varchar(4096) not null default '' comment 'json,map,tagkey->regexp|value',
                                  `cause` varchar(255) not null default '',
                                  `btime` bigint not null default 0 comment 'begin time',
                                  `etime` bigint not null default 0 comment 'end time',
                                  `create_at` bigint not null default 0,
                                  `create_by` varchar(64) not null default '',
                                  PRIMARY KEY (`id`),
                                  KEY (`create_at`),
                                  KEY (`group_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `alert_subscribe` (
                                       `id` bigint unsigned not null auto_increment,
                                       `group_id` bigint not null default 0 comment 'busi group id',
                                       `cluster` varchar(128) not null,
                                       `rule_id` bigint not null default 0,
                                       `tags` varchar(4096) not null default '' comment 'json,map,tagkey->regexp|value',
                                       `redefine_severity` tinyint(1) default 0 comment 'is redefine severity?',
                                       `new_severity` tinyint(1) not null comment '0:Emergency 1:Warning 2:Notice',
                                       `redefine_channels` tinyint(1) default 0 comment 'is redefine channels?',
                                       `new_channels` varchar(255) not null default '' comment 'split by space: sms voice email dingtalk wecom',
                                       `user_group_ids` varchar(250) not null comment 'split by space 1 34 5, notify cc to user_group_ids',
                                       `create_at` bigint not null default 0,
                                       `create_by` varchar(64) not null default '',
                                       `update_at` bigint not null default 0,
                                       `update_by` varchar(64) not null default '',
                                       PRIMARY KEY (`id`),
                                       KEY (`update_at`),
                                       KEY (`group_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `target` (
                              `id` bigint unsigned not null auto_increment,
                              `group_id` bigint not null default 0 comment 'busi group id',
                              `cluster` varchar(128) not null comment 'append to alert event as field',
                              `ident` varchar(191) not null comment 'target id',
                              `note` varchar(255) not null default '' comment 'append to alert event as field',
                              `tags` varchar(512) not null default '' comment 'append to series data as tags, split by space, append external space at suffix',
                              `update_at` bigint not null default 0,
                              PRIMARY KEY (`id`),
                              UNIQUE KEY (`ident`),
                              KEY (`group_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;


    CREATE TABLE `alert_cur_event` (
                                       `id` bigint unsigned not null comment 'use alert_his_event.id',
                                       `cluster` varchar(128) not null,
                                       `group_id` bigint unsigned not null comment 'busi group id of rule',
                                       `hash` varchar(64) not null comment 'rule_id + vector_pk',
                                       `rule_id` bigint unsigned not null,
                                       `rule_name` varchar(255) not null,
                                       `rule_note` varchar(512) not null default 'alert rule note',
                                       `severity` tinyint(1) not null comment '0:Emergency 1:Warning 2:Notice',
                                       `prom_for_duration` int not null comment 'prometheus for, unit:s',
                                       `prom_ql` varchar(8192) not null comment 'promql',
                                       `prom_eval_interval` int not null comment 'evaluate interval',
                                       `callbacks` varchar(255) not null default '' comment 'split by space: http://a.com/api/x http://a.com/api/y',
                                       `runbook_url` varchar(255),
                                       `notify_recovered` tinyint(1) not null comment 'whether notify when recovery',
                                       `notify_channels` varchar(255) not null default '' comment 'split by space: sms voice email dingtalk wecom',
                                       `notify_groups` varchar(255) not null default '' comment 'split by space: 233 43',
                                       `notify_repeat_next` bigint not null default 0 comment 'next timestamp to notify, get repeat settings from rule',
                                       `target_ident` varchar(191) not null default '' comment 'target ident, also in tags',
                                       `target_note` varchar(191) not null default '' comment 'target note',
                                       `trigger_time` bigint not null,
                                       `trigger_value` varchar(255) not null,
                                       `tags` varchar(1024) not null default '' comment 'merge data_tags rule_tags, split by ,,',
                                       PRIMARY KEY (`id`),
                                       KEY (`hash`),
                                       KEY (`rule_id`),
                                       KEY (`trigger_time`, `group_id`),
                                       KEY (`notify_repeat_next`)
    ) ENGINE=InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `alert_his_event` (
                                       `id` bigint unsigned not null AUTO_INCREMENT,
                                       `is_recovered` tinyint(1) not null,
                                       `cluster` varchar(128) not null,
                                       `group_id` bigint unsigned not null comment 'busi group id of rule',
                                       `hash` varchar(64) not null comment 'rule_id + vector_pk',
                                       `rule_id` bigint unsigned not null,
                                       `rule_name` varchar(255) not null,
                                       `rule_note` varchar(512) not null default 'alert rule note',
                                       `severity` tinyint(1) not null comment '0:Emergency 1:Warning 2:Notice',
                                       `prom_for_duration` int not null comment 'prometheus for, unit:s',
                                       `prom_ql` varchar(8192) not null comment 'promql',
                                       `prom_eval_interval` int not null comment 'evaluate interval',
                                       `callbacks` varchar(255) not null default '' comment 'split by space: http://a.com/api/x http://a.com/api/y',
                                       `runbook_url` varchar(255),
                                       `notify_recovered` tinyint(1) not null comment 'whether notify when recovery',
                                       `notify_channels` varchar(255) not null default '' comment 'split by space: sms voice email dingtalk wecom',
                                       `notify_groups` varchar(255) not null default '' comment 'split by space: 233 43',
                                       `target_ident` varchar(191) not null default '' comment 'target ident, also in tags',
                                       `target_note` varchar(191) not null default '' comment 'target note',
                                       `trigger_time` bigint not null,
                                       `trigger_value` varchar(255) not null,
                                       `recover_time` bigint not null default 0,
                                       `last_eval_time` bigint not null default 0 comment 'for time filter',
                                       `tags` varchar(1024) not null default '' comment 'merge data_tags rule_tags, split by ,,',
                                       PRIMARY KEY (`id`),
                                       KEY (`hash`),
                                       KEY (`rule_id`),
                                       KEY (`trigger_time`, `group_id`)
    ) ENGINE=InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `task_tpl`
    (
        `id`        int unsigned NOT NULL AUTO_INCREMENT,
        `group_id`  int unsigned not null comment 'busi group id',
        `title`     varchar(255) not null default '',
        `account`   varchar(64)  not null,
        `batch`     int unsigned not null default 0,
        `tolerance` int unsigned not null default 0,
        `timeout`   int unsigned not null default 0,
        `pause`     varchar(255) not null default '',
        `script`    text         not null,
        `args`      varchar(512) not null default '',
        `tags`      varchar(255) not null default '' comment 'split by space',
        `create_at` bigint not null default 0,
        `create_by` varchar(64) not null default '',
        `update_at` bigint not null default 0,
        `update_by` varchar(64) not null default '',
        PRIMARY KEY (`id`),
        KEY (`group_id`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `task_tpl_host`
    (
        `ii`   int unsigned NOT NULL AUTO_INCREMENT,
        `id`   int unsigned not null comment 'task tpl id',
        `host` varchar(128)  not null comment 'ip or hostname',
        PRIMARY KEY (`ii`),
        KEY (`id`, `host`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `task_record`
    (
        `id` bigint unsigned not null comment 'ibex task id',
        `group_id` bigint not null comment 'busi group id',
        `ibex_address`   varchar(128) not null,
        `ibex_auth_user` varchar(128) not null default '',
        `ibex_auth_pass` varchar(128) not null default '',
        `title`     varchar(255)    not null default '',
        `account`   varchar(64)     not null,
        `batch`     int unsigned    not null default 0,
        `tolerance` int unsigned    not null default 0,
        `timeout`   int unsigned    not null default 0,
        `pause`     varchar(255)    not null default '',
        `script`    text            not null,
        `args`      varchar(512)    not null default '',
        `create_at` bigint not null default 0,
        `create_by` varchar(64) not null default '',
        PRIMARY KEY (`id`),
        KEY (`create_at`, `group_id`),
        KEY (`create_by`)
    ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;
  b-ibex.sql: |
    set names utf8mb4;

    drop database if exists ibex;
    create database ibex;
    use ibex;

    CREATE TABLE `task_meta`
    (
        `id`        bigint unsigned NOT NULL AUTO_INCREMENT,
        `title`     varchar(255)    not null default '',
        `account`   varchar(64)     not null,
        `batch`     int unsigned    not null default 0,
        `tolerance` int unsigned    not null default 0,
        `timeout`   int unsigned    not null default 0,
        `pause`     varchar(255)    not null default '',
        `script`    text            not null,
        `args`      varchar(512)    not null default '',
        `creator`   varchar(64)     not null default '',
        `created`   timestamp       not null default CURRENT_TIMESTAMP,
        PRIMARY KEY (`id`),
        KEY (`creator`),
        KEY (`created`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    /* start|cancel|kill|pause */
    CREATE TABLE `task_action`
    (
        `id`     bigint unsigned not null,
        `action` varchar(32)     not null,
        `clock`  bigint          not null default 0,
        PRIMARY KEY (`id`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `task_scheduler`
    (
        `id`        bigint unsigned not null,
        `scheduler` varchar(128)    not null default '',
        KEY (`id`, `scheduler`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `task_scheduler_health`
    (
        `scheduler` varchar(128) not null,
        `clock`     bigint       not null,
        UNIQUE KEY (`scheduler`),
        KEY (`clock`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE `task_host_doing`
    (
        `id`     bigint unsigned not null,
        `host`   varchar(128)    not null,
        `clock`  bigint          not null default 0,
        `action` varchar(16)     not null,
        KEY (`id`),
        KEY (`host`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE task_host_0
    (
        `ii`     bigint unsigned NOT NULL AUTO_INCREMENT,
        `id`     bigint unsigned not null,
        `host`   varchar(128)    not null,
        `status` varchar(32)     not null,
        `stdout` text,
        `stderr` text,
        UNIQUE KEY (`id`, `host`),
        PRIMARY KEY (`ii`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE task_host_1
    (
        `ii`     bigint unsigned NOT NULL AUTO_INCREMENT,
        `id`     bigint unsigned not null,
        `host`   varchar(128)    not null,
        `status` varchar(32)     not null,
        `stdout` text,
        `stderr` text,
        UNIQUE KEY (`id`, `host`),
        PRIMARY KEY (`ii`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE task_host_2
    (
        `ii`     bigint unsigned NOT NULL AUTO_INCREMENT,
        `id`     bigint unsigned not null,
        `host`   varchar(128)    not null,
        `status` varchar(32)     not null,
        `stdout` text,
        `stderr` text,
        UNIQUE KEY (`id`, `host`),
        PRIMARY KEY (`ii`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;

    CREATE TABLE task_host_3
    (
        `ii`     bigint unsigned NOT NULL AUTO_INCREMENT,
        `id`     bigint unsigned not null,
        `host`   varchar(128)    not null,
        `status` varchar(32)     not null,
        `stdout` text,
        `stderr` text,
        UNIQUE KEY (`id`, `host`),
        PRIMARY KEY (`ii`)
    ) ENGINE = InnoDB
      DEFAULT CHARSET = utf8mb4;
  c-init.sql: |-
    GRANT ALL ON *.* TO 'root'@'127.0.0.1' IDENTIFIED BY 'root';
    GRANT ALL ON *.* TO 'root'@'localhost' IDENTIFIED BY 'root';
    GRANT ALL ON *.* TO 'root'@'%' IDENTIFIED BY 'root';
  d-init-private.sql: |-
    set names utf8mb4;
    use n9e_v5;
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点内存使用率高','from-sql',1,1,300,
            '(1 - (node_memory_MemAvailable_bytes{job="expose-node-metrics"} / (node_memory_MemTotal_bytes{job="expose-node-metrics"})))* 100>90',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点TIME_WAIT超过30000','from-sql',1,1,300,
            'node_sockstat_TCP_tw{job="expose-node-metrics"}>30000',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','最近5分钟节点CPU负载高占比(负载/核数)','from-sql',1,1,300,
            'sum(node_load5) by (node,prometheus_from)  / sum(machine_cpu_cores) by (node,prometheus_from) * 100>200',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点CPU使用率高','from-sql',1,1,300,
            '(1 - avg(rate(node_cpu_seconds_total{mode="idle",job="expose-node-metrics"}[5m])) by (instance, prometheus_from)) * 100>80',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点TCP连接数高于30000','from-sql',1,1,300,
            'node_netstat_Tcp_CurrEstab{job="expose-node-metrics"}>30000',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点磁盘告警','from-sql',1,1,300,
            '(node_filesystem_size_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*",job="expose-node-metrics"}-node_filesystem_free_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*",job="expose-node-metrics"}) *100/(node_filesystem_avail_bytes {fstype=~"ext.*|xfs",mountpoint !~".*pod.*",job="expose-node-metrics"}+(node_filesystem_size_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*",job="expose-node-metrics"}-node_filesystem_free_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*",job="expose-node-metrics"}))>85',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','stable rocketmq集群采集Down','from-sql',1,1,300,
            'up{clustername="stable_rocketmq"}==0',5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,
            1,'','',' severity=critical',1645706446,'root',
            1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','kafka exporter down','from-sql',1,0,120,'up{app="kafka-export"}==0',5,
            '00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','kafka nodeexport down','from-sql',1,1,300,
            'up{service="kafka-node-export"}==0',5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,
            '','',' severity=warning',1645706446,'root',1645706709,
            'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','zookeeper 节点不可用','from-sql',1,1,300,'zk_up==0',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','kafka node down','from-sql',1,0,120,
            'up{service="kafka-jvm-export-stable"}==0',5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',
            60,1,'','',' severity=critical',1645706446,'root',
            1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','Watchdog','from-sql',1,0,60,'vector(1)==1',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',' severity=info',
            1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器内存使用率高于90%','from-sql',1,1,300,
            'sum (container_memory_rss{container !="",container!="POD",namespace!~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}) by (container,namespace,pod,prometheus_from)/ (sum(container_spec_memory_limit_bytes{container !="",container!="POD",namespace!~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}) by (container,namespace,pod,prometheus_from) != 0) * 100>90',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器最近5分钟重启大于3','from-sql',1,1,300,
            'increase(kube_pod_container_status_restarts_total{namespace!~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}[10m])>3',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器处于非运行状态','from-sql',1,1,300,
            'sum by (namespace, pod, phase, prometheus_from) (kube_pod_status_phase{phase=~"Pending|Unknown|Failed",namespace!~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"})>0',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器CPU使用率高于80%','from-sql',1,1,300,
            'sum by (namespace, pod_name, prometheus_from) (rate(container_cpu_usage_seconds_total{namespace!~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos",container_name!="",container_name!="POD"}[5m]))  / sum by (namespace, pod_name, prometheus_from) (kube_pod_container_resource_limits_cpu_cores) * 100>80',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','应用容器内存超限制被杀死(OOM)','from-sql',1,1,300,
            'kube_pod_container_status_last_terminated_reason{reason="OOMKilled",namespace!~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}>0',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点网络异常','from-sql',1,0,120,
            'kube_node_status_condition{condition="NetworkUnavailable",status="true"}==1',5,'00:00',
            '23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点健康检查失败','from-sql',1,0,120,
            'kube_node_status_condition{condition="Ready",status="true"}==0',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点PID数不足','from-sql',1,0,120,
            'kube_node_status_condition{condition="PIDPressure",status="true"}==1',5,'00:00',
            '23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','节点内存不足','from-sql',1,0,120,
            'kube_node_status_condition{condition="MemoryPressure",status="true"}==1',5,'00:00',
            '23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器平均内存使用率高(RSS)','from-sql',1,1,300,
            'sum (container_memory_rss{container !="",container!="POD",namespace=~"istio.*"}) by (container,namespace,pod)/ (sum(container_spec_memory_limit_bytes{container !="",container!="POD",namespace=~"istio.*"}) by (container,namespace,pod) != 0) * 100>85',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器处于非运行状态','from-sql',1,1,300,
            'sum by (namespace, pod, phase) (kube_pod_status_phase{phase=~"Pending|Unknown|Failed",namespace=~"istio.*"})>0',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器CPU使用率高(Limit)','from-sql',1,1,300,
            'sum by (namespace, pod) (rate(container_cpu_usage_seconds_total{namespace=~"istio.*",container_name!="",container_name!="POD"}[5m]))  / sum by (namespace, pod) (kube_pod_container_resource_limits_cpu_cores) * 100>80',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','istio 云平台应用可用率告警','from-sql',1,1,300,
            '(sum(irate(istio_requests_total{response_code!~"5.*", destination_workload!="unknown"}[5m])) by (destination_workload, destination_workload_namespace) != 0) / (sum(irate(istio_requests_total{}[5m])) by (destination_workload, destination_workload_namespace) != 0)<0.9',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','istio采集规则Down','from-sql',1,1,300,'up{job=~"istio.*"}!=1',5,'00:00',
            '23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','应用最近五分钟请求平均耗时大于5秒','from-sql',1,1,300,
            'rate(istio_request_duration_milliseconds_sum[1m]) / rate(istio_request_duration_milliseconds_count[1m])>5000',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器最近5分钟重启次数高','from-sql',1,1,300,
            'increase(kube_pod_container_status_restarts_total{namespace=~"istio.*"}[5m])>3',5,
            '00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','应用容器内存超限制被杀死(OOM)','from-sql',1,1,300,
            'kube_pod_container_status_last_terminated_reason{reason="OOMKilled",namespace=~"istio.*"}>0',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','istio 应用指标采集Down','from-sql',1,1,300,
            'up{kubernetes_namespace=~"istio.*"}!=1',5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',
            60,1,'','',' severity=warning',1645706446,'root',
            1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','应用容器内存超限制被杀死(OOM)','from-sql',1,1,300,
            'kube_pod_container_status_last_terminated_reason{reason="OOMKilled",namespace=~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}>0',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器平均内存使用率高于90%','from-sql',1,1,300,
            'sum (container_memory_rss{container !="",container!="POD",namespace=~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}) by (container,namespace,pod, prometheus_from)/ (sum(container_spec_memory_limit_bytes{container !="",container!="POD",namespace=~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}) by (container,namespace,pod, prometheus_from) != 0) * 100>90',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器CPU使用率高于80%','from-sql',1,1,300,
            'sum by (namespace, pod_name, prometheus_from) (rate(container_cpu_usage_seconds_total{namespace=~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos",container_name!="",container_name!="POD"}[5m]))  / sum by (namespace, pod_name, prometheus_from) (kube_pod_container_resource_limits_cpu_cores) * 100>80',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器处于非运行状态','from-sql',1,1,300,
            'sum by (namespace, pod, phase, prometheus_from) (kube_pod_status_phase{phase=~"Pending|Unknown|Failed",namespace=~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"})>0',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','容器最近5分钟重启次数大于3','from-sql',1,0,240,
            'increase(kube_pod_container_status_restarts_total{namespace=~"cadvisor|cattle-prometheus|ingress-nginx|kube-system|thanos"}[10m])>2',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','ApiServer请求错误率高','from-sql',1,0,120,
            'sum(rate(apiserver_request_count{job="kubernetes",code=~"^(?:5..)$"}[2m])) by (prometheus_from) / sum(rate(apiserver_request_count{job="kubernetes"}[2m])) by (prometheus_from)  * 100>0.5',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','核心组件Controller-Manager状态告警','from-sql',1,0,60,
            'up{service="expose-kube-cm-metrics"}!=1',5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',
            60,1,'','',' severity=critical',1645706446,'root',
            1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','etcd没有leader告警','from-sql',1,0,120,'etcd_server_has_leader!=1',5,
            '00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','etcd频繁选举告警','from-sql',1,0,180,
            'increase(etcd_server_leader_changes_seen_total[1h])>3',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','核心组件Apiserver状态告警','from-sql',1,0,60,'up{service="kubernetes"}!=1',5,
            '00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','核心组件CoreDNS状态告警','from-sql',1,0,180,
            'kube_pod_status_phase{phase="Running", pod =~"coredns.*?"}!=1',5,'00:00','23:59',
            '1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=warning',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','ApiServer延时告警','from-sql',1,0,60,
            'histogram_quantile(0.95, sum(rate(apiserver_request_duration_seconds_bucket{verb!~"CONNECT|WATCH"}[5m])) by (le)) * 1000>500',
            5,'00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','etcd 磁盘写入数据延时告警','from-sql',1,0,180,
            'histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket[2m]))>0.5',5,
            '00:00','23:59','1 2 3 4 5 6 0',0,1,'','1',60,1,'','',
            ' severity=critical',1645706446,'root',1645706709,'root');
    INSERT INTO `alert_rule`
    VALUES (null,1,'Prometheus','核心组件Scheduler状态告警','from-sql',1,0,60,
            'up{service="expose-kube-scheduler-metrics"}!=1',5,'00:00','23:59','1 2 3 4 5 6 0',0,1,
            '','1',60,1,'','',' severity=critical',1645706446,
            'root',1645706709,'root');
kind: ConfigMap
metadata:
  name: mysql-init
{{- end }}